<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>බිල්පත් ඉතිහාසය - Yomesh Stores</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f0f8ff; }
.container { max-width: 900px; margin:auto; padding:20px; }
h2 { text-align:center; color:#004a99; margin-bottom:15px; }
#filters { display:flex; flex-direction:column; gap:10px; margin-bottom:15px; }
#yearSelect { padding:10px; border-radius:6px; border:1px solid #aaa; font-size:1rem; }
.months { display:flex; overflow-x:auto; overflow-y:hidden; gap:10px; padding-bottom:5px; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
.months::-webkit-scrollbar { height:6px; }
.months::-webkit-scrollbar-thumb { background: #aaa; border-radius:3px; }
.month-tag { flex:0 0 auto; padding:10px 16px; background:#dde6f7; border-radius:20px; cursor:pointer; white-space:nowrap; font-size:1rem; text-align:center; min-width:60px; }
.month-tag.active { background:#004a99; color:white; font-weight:bold; }
#searchInput { width:100%; padding:12px; border-radius:8px; border:1.5px solid #aaa; font-size:1rem; box-sizing:border-box; }
.table-wrapper { overflow-x:auto; background:white; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15); padding:10px; }
table { width:100%; border-collapse:collapse; min-width:800px; }
th, td { border:1px solid #004a99; padding:10px; text-align:center; word-break:break-word; font-size:0.95rem; }
th { background-color:#004a99; color:white; }
tr:nth-child(even) { background-color:#dde6f7; }
button.detailsBtn { background:#007bff; border:none; color:white; padding:6px 12px; border-radius:6px; cursor:pointer; white-space:nowrap; }
button.detailsBtn:hover { background:#0056b3; }
#backBtn { margin-top:20px; width:100%; background:#004a99; border:none; color:white; padding:12px 0; border-radius:8px; cursor:pointer; font-size:1rem; }
@media (max-width:480px){
  th, td{ font-size:0.75rem; padding:6px 4px; }
  .month-tag{ padding:12px 18px; font-size:0.85rem; min-width:70px; }
  #yearSelect, #searchInput{ font-size:0.9rem; padding:10px; }
}
</style>
</head>
<body>

<div class="container">
  <button id="backBtn">ආපසු</button>
  <h2>බිල්පත් ඉතිහාසය</h2>

  <div id="filters">
    <select id="yearSelect"></select>
    <div class="months" id="monthsContainer"></div>
  </div>

  <input type="text" id="searchInput" placeholder="සෙවීම: බිල් වර්ගය, ගිනුම් අංකය, යොමු අංකය හෝ දුරකථන අංකය" />

  <div class="table-wrapper">
    <table id="billsTable">
      <thead>
        <tr>
          <th>බිල් වර්ගය</th>
          <th>ගිනුම් අංකය</th>
          <th>යොමු අංකය</th>
          <th>ගාණ (රු.)</th>
          <th>දුරකථන අංකය</th>
          <th>දිනය</th>
          <th>විස්තර බලන්න</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="7">බිල්පත් නොමැත.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const billsTableBody = document.querySelector('#billsTable tbody');
const backBtn = document.getElementById('backBtn');
const searchInput = document.getElementById('searchInput');
const yearSelect = document.getElementById('yearSelect');
const monthsContainer = document.getElementById('monthsContainer');

let selectedYear = new Date().getFullYear();
let selectedMonth = new Date().getMonth() + 1; // 1-12
const monthNames = ["ජනවාරි ","පෙබරවාරි","මාර්තු","අප්‍රේල්","මැයි","ජුනි","ජුලි","අගෝස්තු","සැප්තැම්බර්","ඔක්තෝම්බර්","නොවැම්බර්","දෙසැම්බර්"];
let allBills = [];

// Render year options
function renderYearOptions(){
  const currentYear = new Date().getFullYear();
  for(let y=currentYear; y>=currentYear-5; y--){
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    if(y===selectedYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}

// Render month tags
function renderMonthTags(){
  monthsContainer.innerHTML = '';
  monthNames.forEach((m,i)=>{
    const tag = document.createElement('div');
    tag.className = 'month-tag'+((i+1)===selectedMonth?' active':'');
    tag.textContent = m;
    tag.dataset.month = i+1;
    tag.addEventListener('click',()=>{
      selectedMonth = i+1;
      document.querySelectorAll('.month-tag').forEach(t=>t.classList.remove('active'));
      tag.classList.add('active');
      tag.scrollIntoView({behavior:"smooth", inline:"center"}); 
      renderBills(allBills); 
    });
    monthsContainer.appendChild(tag);
  });

  const activeTag = document.querySelector('.month-tag.active');
  if(activeTag){
    activeTag.scrollIntoView({behavior:"smooth", inline:"center"});
  }
}

// Render bills
function renderBills(bills){
  billsTableBody.innerHTML='';
  if(!bills || bills.length===0){
    billsTableBody.innerHTML='<tr><td colspan="7">බිල්පත් නොමැත.</td></tr>';
    return;
  }

  const filtered = bills.filter(b=>{
    if(!b.date) return false;
    const d = new Date(b.date);
    return d.getFullYear() === selectedYear && d.getMonth()+1 === selectedMonth;
  });

  if(filtered.length===0){
    billsTableBody.innerHTML='<tr><td colspan="7">බිල්පත් නොමැත.</td></tr>';
    return;
  }

  filtered.slice().reverse().forEach(b=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${b.bill_type||''}</td>
      <td>${b.account_number||''}</td>
      <td>${b.reference_number||''}</td>
      <td>${b.base_amount!==undefined?Number(b.base_amount).toFixed(2):'0.00'}</td>
      <td>${b["Phone number"]||''}</td>
      <td>${b.date||''}</td>
      <td><button class="detailsBtn">විස්තර</button></td>
    `;
    tr.querySelector('.detailsBtn').addEventListener('click',()=>{ 
      window.location.href=`bill.html?id=${b.id}`; 
    });
    billsTableBody.appendChild(tr);
  });
}

// Load bills via proxy
async function loadAllBills(){
  try{
    let all=[];
    let next = "limit=200"; 
    while(next){
      const res = await axios.get(
        `https://your-vercel-app.vercel.app/api/proxy?url=${encodeURIComponent(next)}`
      );
      all = all.concat(res.data.results||[]);
      if(res.data.next){
        const query = res.data.next.split("?")[1];
        next = query;
      } else {
        next = null;
      }
    }
    allBills = all;
    renderBills(allBills);
  }catch(err){
    console.error("Proxy error:", err);
    billsTableBody.innerHTML='<tr><td colspan="7">DB load නොවේ.</td></tr>';
  }
}

// Events
backBtn.addEventListener('click',()=>window.location.href='index.html');
searchInput.addEventListener('input', ()=>{
  const term = searchInput.value.toLowerCase();
  billsTableBody.querySelectorAll('tr').forEach(row=>{
    if(row.querySelector('td')){
      row.style.display = row.textContent.toLowerCase().includes(term)?'':'none';
    }
  });
});
yearSelect.addEventListener('change', ()=>{
  selectedYear = parseInt(yearSelect.value);
  renderBills(allBills);
});

// Init
renderYearOptions();
renderMonthTags();
loadAllBills();
</script>
</body>
</html>
