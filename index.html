<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>බිල්පත ඇතුළත් කරන්න - Yomesh Stores</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 420px;
    margin: 20px auto;
    background: #f0f8ff;
    padding: 15px;
    box-sizing: border-box;
  }
  h1 {
    text-align: center;
    color: #004a99;
    margin-bottom: 10px;
  }
  form {
    background: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
    color: #004a99;
  }
  select, input {
    width: 100%;
    padding: 8px 10px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1.5px solid #aaa;
    font-size: 1rem;
    box-sizing: border-box;
  }
  button, #exportBtn, #importBtn {
    margin-top: 20px;
    padding: 12px;
    width: 100%;
    font-size: 1.1rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:disabled, #exportBtn:disabled, #importBtn:disabled {
    background: #80b3ff;
    cursor: not-allowed;
  }
  #message {
    margin-top: 20px;
    font-weight: bold;
    white-space: pre-line;
    text-align: center;
  }
  .export-import-section {
    margin-top: 30px;
    border-top: 1px solid #ccc;
    padding-top: 15px;
  }
  .export-import-section h3 {
    color: #004a99;
    margin-bottom: 10px;
  }
  #importFile {
    width: 100%;
    margin-top: 10px;
  }
  #importBtn {
    margin-top: 10px;
  }
</style>
</head>
<body>

<h1>Yomesh Stores - නව බිල්පතක් ඇතුළත් කරන්න</h1>

<form id="billForm" novalidate>
  <label for="billType">බිල් වර්ගය</label>
  <select id="billType" required>
    <option value="" disabled selected>-- තෝරන්න --</option>
    <option value="LECO">LECO</option>
    <option value="NWSDB">NWSDB</option>
    <option value="DIALOG TV">DIALOG TV</option>
  </select>

  <label for="accountNumber">ගිනුම් අංකය</label>
  <input type="number" id="accountNumber" min="0" required placeholder="ගිනුම් අංකය ඇතුළත් කරන්න" />

  <label for="referenceNumber">යොමු අංකය</label>
  <input type="number" id="referenceNumber" min="0" required placeholder="යොමු අංකය ඇතුළත් කරන්න" />

  <label for="baseAmount">ගාණ (රු.)</label>
  <input type="number" id="baseAmount" min="0" step="0.01" required placeholder="ගාණ ඇතුළත් කරන්න" />

  <button type="submit" id="submitBtn">සම්පූර්ණ කරන්න</button>
</form>

<button id="historyBtn" type="button" style="margin-bottom:15px; width:100%; padding:12px; font-size:1.1rem; background:#28a745; color:#fff; border:none; border-radius:8px; cursor:pointer;">
  බිල්පත් ඉතිහාසය බලන්න
</button>

<div id="message"></div>

<div class="export-import-section">
  <h3>බිල්පත් Export / Import</h3>
  <button id="exportBtn" type="button" title="Save bills backup to JSON file">Export Bills</button>
  <input type="file" id="importFile" accept=".json" />
  <button id="importBtn" type="button" title="Load bills from JSON file">Import Bills</button>
  <p id="importExportMsg"></p>
</div>

<script>
  const billForm = document.getElementById('billForm');
  const billType = document.getElementById('billType');
  const accountNumber = document.getElementById('accountNumber');
  const referenceNumber = document.getElementById('referenceNumber');
  const baseAmount = document.getElementById('baseAmount');
  const submitBtn = document.getElementById('submitBtn');
  const messageDiv = document.getElementById('message');

  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');
  const importExportMsg = document.getElementById('importExportMsg');

  const STORAGE_KEY = 'yomeshBills';

  billForm.addEventListener('submit', e => {
    e.preventDefault();
    messageDiv.textContent = '';
    messageDiv.style.color = 'black';
    submitBtn.disabled = true;
    submitBtn.textContent = 'සම්පූර්ණ වෙමින්...';

    if (!billType.value) {
      alert('බිල් වර්ගය තෝරන්න!');
      billType.focus();
      submitBtn.disabled = false;
      submitBtn.textContent = 'සම්පූර්ණ කරන්න';
      return;
    }

    const accNum = parseInt(accountNumber.value, 10);
    const refNum = parseInt(referenceNumber.value, 10);
    const base = parseFloat(baseAmount.value);

    if (isNaN(accNum) || isNaN(refNum) || isNaN(base)) {
      alert('සියලු ක්ෂේත්‍ර වල නිවැරදි අගයන් ඇතුළත් කරන්න!');
      submitBtn.disabled = false;
      submitBtn.textContent = 'සම්පූර්ණ කරන්න';
      return;
    }

    const bills = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const newBill = {
      id: Date.now(),
      billType: billType.value,
      accountNumber: accNum,
      referenceNumber: refNum,
      baseAmount: base,
      submittedAt: new Date().toISOString(),
    };
    bills.push(newBill);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(bills));

    messageDiv.style.color = 'green';
    messageDiv.textContent = 'බිල්පත සාර්ථකව සුරක්ෂිත කරන ලදි!';

    billForm.reset();
    submitBtn.disabled = false;
    submitBtn.textContent = 'සම්පූර්ණ කරන්න';
    window.location.href = `bill.html?id=${newBill.id}`;
  });

  exportBtn.addEventListener('click', async () => {
    const bills = localStorage.getItem(STORAGE_KEY);
    if (!bills) {
      alert('සුරක්ෂිත කළ බිල්පත් නොමැත.');
      return;
    }
    const blob = new Blob([bills], { type: 'application/json' });
    const fileName = `bills_backup_${new Date().toISOString().slice(0, 10)}.json`;
    const file = new File([blob], fileName, { type: 'application/json' });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          files: [file],
          title: 'Yomesh Bills Backup',
          text: 'Yomesh Stores බිල්පත් backup ගොනුව',
        });
        alert('ගොනුව share කරන ලදි!');
      } catch (error) {
        alert('Share කිරීම අසාර්ථක විය: ' + error.message);
      }
    } else {
      alert('මෙම device එකට share කිරීම සහය දක්වන්නේ නැත.\nඔබට ගොනුව save කර share කරන්න පුළුවන්.');
      // fallback: download file manually
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  });

  importBtn.addEventListener('click', () => {
    importExportMsg.textContent = '';
    const file = importFile.files[0];
    if (!file) {
      alert('Import කිරීම සඳහා JSON ගොනුවක් තෝරන්න.');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        if (!Array.isArray(importedData)) {
          throw new Error('ගොනුව අනුමාන කළ ආකෘතියට නොගැළපේ.');
        }
        const existingBills = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const mergedBills = [...existingBills];

        importedData.forEach(newBill => {
          if (!existingBills.find(b => b.id === newBill.id)) {
            mergedBills.push(newBill);
          }
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(mergedBills));
        importExportMsg.style.color = 'green';
        importExportMsg.textContent = `Import සාර්ථකයි! එක් කරන ලද අයිතම: ${importedData.length}`;
        importFile.value = '';
      } catch (err) {
        alert('Import දෝෂයක්: ' + err.message);
      }
    };
    reader.readAsText(file);
  });

  document.getElementById('historyBtn').addEventListener('click', () => {
    window.location.href = 'billHistory.html'; 
  });
</script>

</body>
</html>
